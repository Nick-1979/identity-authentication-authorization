<!DOCTYPE html>
<html>
<head>    
	<title>Client</title>
    <meta charset="utf-8">
    <meta name = "viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href = "css/bootstrap.min.css" rel="stylesheet">
    
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
               IAA Example Client
            </div>
            <div class="card-body">
                <h5 class="card-title">IoT Resource access.</h5>
                <p>Make sure you have the console open in order to monitor the log messages</p>
                <div class="form-group">
                    <label for="url">Username</label>
                    <input type="text" class="form-control" id="username" value="sofie">
                    <label for="url">Password</label>
                    <input type="password" class="form-control" id="password" value="sofie!">
                </div>
                <button class="btn btn-default" id="direct-access-btn">Retrieve access token directly</button>
                <button class="btn btn-default" id="first-btn">Retrieve access through a smart contact</button>
                <br/><br/>
                <div class="form-group">
                    <label for="url">Access token</label>
                    <input type="text" class="form-control" id="token" value="access token:" disabled>
                </div>
                <button class="btn btn-default" id="second-btn">Access resource</button>
                <br/>
            </div>
        </div>
        <div id="response"></div>
    </div>
</body>
<script src="js/conf.js"></script>
<script src="js/nacl.min.js"></script>
<script src="js/ctcore.js"></script>
<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.2.0/dist/web3.min.js"></script>
<script>

    var ACPPubKeyBase64;
    var textEncoder  = new TextEncoder();
    var challenge = "";
    var access;
    var web3Provider    = "ws://195.251.234.25:8546"; 
    var ethAccountAddr  = "0xd248841946ccc10e030de89aa88db662d32ab7c5"; // ***Account must be unlocked***

    window.addEventListener('load',  async() =>{
        document.getElementById("direct-access-btn").addEventListener("click", authServerCall);
            const web3 = new Web3(new Web3.providers.WebsocketProvider(web3Provider));
            access = new web3.eth.Contract(ABI,contractAddress);
            access.events.hashLockCreatedEvent().on('data', hashLockCreatedEventHandler);
            access.events.hashLockOpenedEvent().on('data', hashLockOpenedEventHandler)
    }); 
    
    function authServerCall()
    {
        
        var xhttp    = new XMLHttpRequest();
        var username = document.getElementById("username").value;
        var password = document.getElementById("password").value;
        var tokenbox = document.getElementById("token")
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
                console.log ("Received from OAuth Server: " + this.responseText);
                tokenbox.value = this.responseText;
            }
        };
        xhttp.open("POST",authServerURL+"?method=direct", true);
        xhttp.setRequestHeader("Authorization", "Basic " + btoa(username + ":" + password)); 
        xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"); 
        xhttp.send("grant_type=client_credentials");
    }

    function hashLockCreatedEventHandler(result)
    {

        var lock = result.returnValues.lock;
        access.methods.deposit(lock, 0).send({from:ethAccountAddr, gas: 3000000, value: web3.toWei("1", "gwei")},function(error, result) { 
            if (!error)
            {
                console.log(`Deposit function has been invoked for ${lock}`);  
            }else
            {
                console.log("Error: " + error); 
            } 
        });
        console.log(`Lock created ${lock}`);         
        
    }

    function hashLockOpenedEventHandler(result)
    {
        var key = result.returnValues.key;
        console.log(`Received token decryption key ${key}`);         
    }

</script>
